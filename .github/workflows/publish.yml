name: Publish docker image

on:
  workflow_call:
      
jobs:
    push:
      name: Push
      timeout-minutes: 10
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: Actions/checkout@v3
          with:
            repository: ${{ github.repository }}
            ref: ${{ github.ref_name }}
            fetch-depth: 0
        
        - name: Load variables
          uses: dolorestec/devops/.github/actions/variables/load@develop

        - name: Cache 
          id: cache
          uses: actions/cache@v3
          env:
            cache-name: ${{ env.DLRS_NAME }}":"${{ env.DLRS_VERSION }}
          with:
            path: ~/.build-cache
            key: ${{ env.cache-name }}-${{ hashFiles('**/pyproject.toml') }}
            restore-keys: |
              ${{ env.DLRS_NAME }}":"${{ env.DLRS_VERSION }}

        - name: Docker build
          uses: dolorestec/devops/.github/actions/docker/build@develop
          with:
            image: ${{ env.DLRS_IMAGE_NAME }}
            tag: ${{ env.DLRS_VERSION }}
            context: .
            dockerfile: Dockerfile

        - name: Docker publish
          uses: dolorestec/devops/.github/actions/docker/push@develop
          with:
            user: ${{ github.actor }}
            token: ${{ secrets.DOCKER_TOKEN }}
            image: ${{ env.DLRS_IMAGE_NAME }}
            tag: ${{ env.DLRS_VERSION }}